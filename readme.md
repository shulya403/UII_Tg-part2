# СОЗДАНИЕ TELEGRAM БОТА - ЧАСТЬ 2
(инструкция для Windows)

## Подготовка среды

1.	Скачайте архив с материалом встречи "Создание Telegram-бота с chatGPT. Часть 2".
2.	Распакуйте его в папке ваших проектов, например c:\users\user\Python
3.	Открываем в редакторе проект webservice с помощью команды Open Folder (Открыть папку)
4.	Открываем новый терминал.
5.	Создадим виртуальное окружение:
	python -m venv .venv
6.	Активируем виртуальное окружение:
	.venv\Scripts\activate (или source .venv/bin/activate для Linux) 
7.	Установим библиотеки:
	pip install -r requirements.txt	
8.	Обновим установщик pip:
	python.exe -m pip install --upgrade pip
	
## Запуск API

1.	В терминале переходим в каталог api:
	cd api
2.	Укажите ключ OPENAI_API_KEY в файле api/.env:
	OPENAI_API_KEY = sk-proj-OjWfvsRL7o0BfzUlMZ_4fBsXXx7OS2Ic523423434sdfsfdfs0D5cPLx3kJqQDadG
3.	Включите VPN (версия для компьютера)
4.	Выполните команду:
	uvicorn main:app --reload
	
## Создание терминала для запуска Telegram

1.	Открываем новый терминал и запускаем виртуальное окружение:
	.venv\Scripts\activate 
2.	Укажите ключ TG_TOKEN в файле telegram/.env:
	TG_TOKEN = 8167966505:AAHYetGagXS_9tVfGaG:LK:LKKDF3HTw
3.	Перейдите в каталог telegram:
	cd telegram 
	
## Файл sync.py - синхронный вызов API

1.	Запустите бота:
	python sync.py
2.	В терминале должна появиться надпись:
	Бот запущен...
3.	В телеграм-клиенте нажмите "Старт" или введите команду /start, бот должен ответить:
	Привет! Это пример синхронного обращений к API
4.	Отправьте любое сообщение, вы в ответ должны получить сообщения от API.
5.	Вернитесь в проект и в терминале нажмите комбинацию кнопок на клавиатуре CTRL + C
6.	В терминале должна появиться надпись:
	Бот остановлен
	
## Файл async.py - асинхронный вызов API

1.	Обратите внимание, в файле api/chunks.py внесены изменения:
	-	добавлен импорт модулей:
		from openai import AsyncOpenAI
		import aiohttp
		import time
		import json	
	-	добавлены в класс Chunk методы request и get_answer_async

2.	В файл api/main.py добавлен обработчик асинхронных запросов:

	```python
	@app.post('/api/get_answer_async')
	async def get_answer_async(question: ModelAnswer):
		answer = await chunk.get_answer_async(query = question.text)
		return {'message': answer}    
	```

3.	Запустите бота:
	python async.py
4.	В терминале должна появиться надпись:
	Бот запущен...
5.	В телеграм-клиенте нажмите "Старт" или введите команду /start, бот должен ответить:
	Привет! Это пример асинхронного обращений к API
6.	Отправьте любое сообщение, вы в ответ должны получить сообщения от API.	
7.	Вернитесь в проект и в терминале нажмите комбинацию кнопок на клавиатуре CTRL + C
8.	В терминале должна появиться надпись:
	Бот остановлен	

## Файл ocr.py - распознавание изображения

1.	Обратите внимание, в файле api/chunks.py внесены изменения:
	-	метод ocr_image добавлен в Chunk

2.	В файл api/main.py добавлены параметры изображения и обработчик запроса /api/image_ocr:

	```python
	# класс параметров распознавания изображения
	class ModelOcr(BaseModel):
		image: str
		text: str	
	
	# функция распознавания изображения
	@app.post('/api/image_ocr')
	async def post_ocr(question: ModelOcr):
		answer = await chunk.ocr_image({
			'image': question.image,
			'text': question.text
		})
		return {'message': answer} 
	```

3.	Запустите бота:
	python ocr.py
4.	В терминале должна появиться надпись:
	Бот запущен...
5.	В телеграм-клиенте нажмите "Старт" или введите команду /start, бот должен ответить:
	Привет! Это пример распознавания изображения
6.	Попробуйте в Телеграм-клиенте отправить картинку с текстом,
	текст будет распознан
7.	Попробуйте в Телеграм-клиенте отправить произвольную картинку,
	и в описании к картинке напишите задание для модели OpenAI,
	какую информацию вы хотите получить, например "Опиши - что изображено на картинке".
	Модель должна прислать свой ответ в виде текста.
8.	Вернитесь в проект и в терминале нажмите комбинацию кнопок на клавиатуре CTRL + C
9.	В терминале должна появиться надпись:
	Бот остановлен	
	
## Файл simble.py - консультант компании "Simble"

1.	В файле используется планировщик,
	-	в нем использована библиотека python-telegram-bot[job-queue] (добавлена в requirements.txt)
2.	Запустите бота:
	python simble.py
3.	В терминале должна появиться надпись:
	Бот запущен...
4.	В телеграм-клиенте нажмите "Старт" или введите команду /start, бот должен ответить:
	Привет! Я консультант компании Simble!
5.	Отправьте любое сообщение, вы в ответ должны получить сообщения от API с учетом
	информации из базы знаний о компании "Simble"
6.	Протестируйте счетчик количества обращений, достижения лимита запросов в минуту.
7.	Вернитесь в проект и в терминале нажмите комбинацию кнопок на клавиатуре CTRL + C
8.	В терминале должна появиться надпись:
	Бот остановлен	

## Файл game1.py - пример игры с использованием истории диалога

1.	В файл api/main.py добавлены параметры запроса и обработчик метода /api/request:

	```python
	# класс параметров запроса к openai
	class ModelRequest(BaseModel):
		system: str = ''
		user: str = ''
		temperature: float = 0.5
		format: dict = None	
	
	# функция обращения к openai
	@app.post('/api/request')
	async def post_request(question: ModelRequest):
		answer = await chunk.request(
			system = question.system,
			user = question.user,
			temp = question.temperature,
			format = question.format
		)
		return {'message': answer}
	```
	
2.	Запустите бота:
	python game1.py
3.	В терминале должна появиться надпись:
	Бот запущен...
4.	В телеграм-клиенте нажмите "Старт" или введите команду /start, бот должен ответить:
	Привет! Это игра, в которой бот угадывает слово...
5.	Для запуска игры введите в Телеграм-клиенте команду:
	/game
6.	Протестируйте игру.
7.	Вернитесь в проект и в терминале нажмите комбинацию кнопок на клавиатуре CTRL + C
8.	В терминале должна появиться надпись:
	Бот остановлен	
	
## Файл game2.py - пример игры с использованием истории диалога

1.	Запустите бота:
	python game2.py
2.	В терминале должна появиться надпись:
	Бот запущен...
3.	В телеграм-клиенте нажмите "Старт" или введите команду /start, бот должен ответить:
	Привет! Это игра, в которой бот задает вопрос...
4.	Для запуска игры введите в Телеграм-клиенте команду:
	/game
5.	Протестируйте игру.
6.	Вернитесь в проект и в терминале нажмите комбинацию кнопок на клавиатуре CTRL + C
7.	В терминале должна появиться надпись:
	Бот остановлен		